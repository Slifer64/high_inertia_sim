
arma::mat lwr4p_fkine(const arma::vec &q)
{
  arma::vec s(7), c(7);

  for (int i=0; i<7; i++)
  {
    c(i) = std::cos(q(i));
    s(i) = std::sin(q(i));
  }

  arma::mat fk(4,4);

  fk(0,0)   = c(3)*s(0)*s(2)*s(4)*s(6)-c(0)*s(1)*s(3)*s(4)*s(6)-c(2)*c(4)*s(0)*s(6)-c(6)*s(0)*s(2)*s(3)*s(5)-c(0)*c(1)*c(4)*s(2)*s(6)-c(0)*c(3)*c(6)*s(1)*s(5)-c(2)*c(5)*c(6)*s(0)*s(4)-c(0)*c(1)*c(2)*c(3)*s(4)*s(6)+c(0)*c(1)*c(2)*c(6)*s(3)*s(5)-c(0)*c(1)*c(5)*c(6)*s(2)*s(4)+c(0)*c(4)*c(5)*c(6)*s(1)*s(3)-c(3)*c(4)*c(5)*c(6)*s(0)*s(2)+c(0)*c(1)*c(2)*c(3)*c(4)*c(5)*c(6);
  fk(0,1)   = c(0)*c(3)*s(1)*s(5)*s(6)-c(0)*c(6)*s(1)*s(3)*s(4)-c(2)*c(4)*c(6)*s(0)+c(3)*c(6)*s(0)*s(2)*s(4)+c(2)*c(5)*s(0)*s(4)*s(6)+s(0)*s(2)*s(3)*s(5)*s(6)-c(0)*c(1)*c(4)*c(6)*s(2)-c(0)*c(1)*c(2)*c(3)*c(6)*s(4)-c(0)*c(1)*c(2)*s(3)*s(5)*s(6)+c(0)*c(1)*c(5)*s(2)*s(4)*s(6)-c(0)*c(4)*c(5)*s(1)*s(3)*s(6)+c(3)*c(4)*c(5)*s(0)*s(2)*s(6)-c(0)*c(1)*c(2)*c(3)*c(4)*c(5)*s(6);
  fk(0,2)   = c(2)*s(0)*s(4)*s(5)-c(5)*s(0)*s(2)*s(3)-c(0)*c(3)*c(5)*s(1)+c(0)*c(1)*s(2)*s(4)*s(5)-c(0)*c(4)*s(1)*s(3)*s(5)+c(3)*c(4)*s(0)*s(2)*s(5)+c(0)*c(1)*c(2)*c(5)*s(3)-c(0)*c(1)*c(2)*c(3)*c(4)*s(5);
  fk(0,3)   = 0.39*c(0)*c(1)*c(2)*s(3)-0.39*c(0)*c(3)*s(1)-0.39*s(0)*s(2)*s(3)-0.4*c(0)*s(1)-0.088*c(0)*c(3)*c(5)*s(1)-0.088*c(5)*s(0)*s(2)*s(3)+0.088*c(2)*s(0)*s(4)*s(5)+0.088*c(0)*c(1)*s(2)*s(4)*s(5)-0.088*c(0)*c(4)*s(1)*s(3)*s(5)+0.088*c(3)*c(4)*s(0)*s(2)*s(5)+0.088*c(0)*c(1)*c(2)*c(5)*s(3)-0.088*c(0)*c(1)*c(2)*c(3)*c(4)*s(5);
  fk(1,0)   = c(0)*c(2)*c(4)*s(6)-c(1)*c(4)*s(0)*s(2)*s(6)-c(0)*c(3)*s(2)*s(4)*s(6)-c(3)*c(6)*s(0)*s(1)*s(5)+c(0)*c(6)*s(2)*s(3)*s(5)-s(0)*s(1)*s(3)*s(4)*s(6)+c(0)*c(2)*c(5)*c(6)*s(4)+c(0)*c(3)*c(4)*c(5)*c(6)*s(2)-c(1)*c(2)*c(3)*s(0)*s(4)*s(6)+c(1)*c(2)*c(6)*s(0)*s(3)*s(5)-c(1)*c(5)*c(6)*s(0)*s(2)*s(4)+c(4)*c(5)*c(6)*s(0)*s(1)*s(3)+c(1)*c(2)*c(3)*c(4)*c(5)*c(6)*s(0);
  fk(1,1)   = c(0)*c(2)*c(4)*c(6)-c(6)*s(0)*s(1)*s(3)*s(4)+c(3)*s(0)*s(1)*s(5)*s(6)-c(0)*s(2)*s(3)*s(5)*s(6)-c(1)*c(4)*c(6)*s(0)*s(2)-c(0)*c(3)*c(6)*s(2)*s(4)-c(0)*c(2)*c(5)*s(4)*s(6)-c(1)*c(2)*c(3)*c(6)*s(0)*s(4)-c(0)*c(3)*c(4)*c(5)*s(2)*s(6)-c(1)*c(2)*s(0)*s(3)*s(5)*s(6)+c(1)*c(5)*s(0)*s(2)*s(4)*s(6)-c(4)*c(5)*s(0)*s(1)*s(3)*s(6)-c(1)*c(2)*c(3)*c(4)*c(5)*s(0)*s(6);
  fk(1,2)   = c(0)*c(5)*s(2)*s(3)-c(3)*c(5)*s(0)*s(1)-c(0)*c(2)*s(4)*s(5)+c(1)*s(0)*s(2)*s(4)*s(5)-c(4)*s(0)*s(1)*s(3)*s(5)+c(1)*c(2)*c(5)*s(0)*s(3)-c(0)*c(3)*c(4)*s(2)*s(5)-c(1)*c(2)*c(3)*c(4)*s(0)*s(5);
  fk(1,3)   = 0.39*c(0)*s(2)*s(3)-0.39*c(3)*s(0)*s(1)-0.4*s(0)*s(1)+0.39*c(1)*c(2)*s(0)*s(3)-0.088*c(3)*c(5)*s(0)*s(1)+0.088*c(0)*c(5)*s(2)*s(3)-0.088*c(0)*c(2)*s(4)*s(5)+0.088*c(1)*s(0)*s(2)*s(4)*s(5)-0.088*c(4)*s(0)*s(1)*s(3)*s(5)+0.088*c(1)*c(2)*c(5)*s(0)*s(3)-0.088*c(0)*c(3)*c(4)*s(2)*s(5)-0.088*c(1)*c(2)*c(3)*c(4)*s(0)*s(5);
  fk(2,0)   = c(1)*c(3)*c(6)*s(5)-c(4)*s(1)*s(2)*s(6)+c(1)*s(3)*s(4)*s(6)-c(2)*c(3)*s(1)*s(4)*s(6)+c(2)*c(6)*s(1)*s(3)*s(5)-c(5)*c(6)*s(1)*s(2)*s(4)-c(1)*c(4)*c(5)*c(6)*s(3)+c(2)*c(3)*c(4)*c(5)*c(6)*s(1);
  fk(2,1)   = c(1)*c(6)*s(3)*s(4)-c(4)*c(6)*s(1)*s(2)-c(1)*c(3)*s(5)*s(6)-c(2)*s(1)*s(3)*s(5)*s(6)+c(5)*s(1)*s(2)*s(4)*s(6)-c(2)*c(3)*c(6)*s(1)*s(4)+c(1)*c(4)*c(5)*s(3)*s(6)-c(2)*c(3)*c(4)*c(5)*s(1)*s(6);
  fk(2,2)   = c(1)*c(3)*c(5)+c(2)*c(5)*s(1)*s(3)+c(1)*c(4)*s(3)*s(5)+s(1)*s(2)*s(4)*s(5)-c(2)*c(3)*c(4)*s(1)*s(5);
  fk(2,3)   = 0.4*c(1)+0.39*c(1)*c(3)+0.088*c(1)*c(3)*c(5)+0.39*c(2)*s(1)*s(3)+0.088*c(2)*c(5)*s(1)*s(3)+0.088*c(1)*c(4)*s(3)*s(5)+0.088*s(1)*s(2)*s(4)*s(5)+-0.088*c(2)*c(3)*c(4)*s(1)*s(5)+0.31;
  fk(3,0)   = 0;
  fk(3,1)   = 0;
  fk(3,2)   = 0;
  fk(3,3)   = 1;

  return fk;
}
